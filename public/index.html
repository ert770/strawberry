<!DOCTYPE html>
<html>
<head>
    <title>å¸‚å ´åƒ¹æ ¼æŸ¥è©¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <!-- åŠ è¼‰å‹•ç•« -->
    <div class="loader-container" id="loaderContainer">
        <div class="loader"></div>
    </div>

    <div class="container">
        <h1>è‰è“å¸‚åƒ¹æŸ¥è©¢ç³»çµ±</h1>

        <div class="search-container">
            <label for="startDate">èµ·å§‹æ—¥æœŸï¼š</label>
            <input type="date" id="startDate" class="date-input">

            <label for="endDate">çµæŸæ—¥æœŸï¼š</label>
            <input type="date" id="endDate" class="date-input">

            <label for="marketFilter">å¸‚å ´ï¼š</label>
            <input type="text" id="marketFilter" class="market-filter" placeholder="è«‹è¼¸å…¥å¸‚å ´åç¨±ï¼Œå¯æ¨¡ç³Šæœå°‹">

            <button onclick="queryPrices()" class="search-button">æŸ¥è©¢</button>
        </div>
    </div>

    <div class="container">
        <h2>æ–°å¢å¸‚å ´åƒ¹æ ¼è³‡æ–™</h2>
        <div class="form-container">
            <div class="form-group">
                <label for="inputDate">æ—¥æœŸï¼š</label>
                <input type="date" id="inputDate" required>
                <div class="error-message" id="dateError"></div>
            </div>

            <div class="form-group">
                <label for="inputMarket">å¸‚å ´ï¼š</label>
                <input type="text" id="inputMarket" placeholder="è«‹è¼¸å…¥å¸‚å ´åç¨±" required>
                <div class="error-message" id="marketError"></div>
            </div>

            <div class="form-group">
                <label for="inputProduct">ç”¢å“ï¼š</label>
                <input type="text" id="inputProduct" placeholder="è«‹è¼¸å…¥ç”¢å“åç¨±" required>
                <div class="error-message" id="productError"></div>
            </div>

            <div class="form-group">
                <label for="inputHighPrice">æœ€é«˜åƒ¹ï¼š</label>
                <input type="number" id="inputHighPrice" min="0" step="0.1" placeholder="è«‹è¼¸å…¥æœ€é«˜åƒ¹" required>
                <div class="error-message" id="highPriceError"></div>
            </div>

            <div class="form-group">
                <label for="inputMediumPrice">ä¸­é–“åƒ¹ï¼š</label>
                <input type="number" id="inputMediumPrice" min="0" step="0.1" placeholder="è«‹è¼¸å…¥ä¸­é–“åƒ¹" required>
                <div class="error-message" id="mediumPriceError"></div>
            </div>

            <div class="form-group">
                <label for="inputLowPrice">æœ€ä½åƒ¹ï¼š</label>
                <input type="number" id="inputLowPrice" min="0" step="0.1" placeholder="è«‹è¼¸å…¥æœ€ä½åƒ¹" required>
                <div class="error-message" id="lowPriceError"></div>
            </div>

            <div class="form-group">
                <label for="inputAveragePrice">å¹³å‡åƒ¹ï¼š</label>
                <input type="number" id="inputAveragePrice" min="0" step="0.1" placeholder="è«‹è¼¸å…¥å¹³å‡åƒ¹" required>
                <div class="error-message" id="averagePriceError"></div>
            </div>

            <div class="form-group">
                <label for="inputTradingVolume">äº¤æ˜“é‡ï¼š</label>
                <input type="number" id="inputTradingVolume" min="0" placeholder="è«‹è¼¸å…¥äº¤æ˜“é‡" required>
                <div class="error-message" id="tradingVolumeError"></div>
            </div>

            <button onclick="submitData()" class="submit-button">æäº¤è³‡æ–™</button>
        </div>
    </div>

    <div class="container result-container" style="display: none;">
        <!-- åƒ¹æ ¼çµ±è¨ˆæ‘˜è¦ -->
        <div id="summaryContainer" class="summary-container" style="display: none;">
            <div class="summary-title">åƒ¹æ ¼çµ±è¨ˆæ‘˜è¦</div>
            <div class="summary-item">
                <span>å…¨æœŸé–“å¹³å‡åƒ¹ï¼š</span>
                <span id="avgPrice"></span>
            </div>
            <div class="summary-item">
                <span>æœ€é«˜åƒ¹æ—¥æœŸï¼š</span>
                <span id="highestDate"></span>
            </div>
            <div class="summary-item">
                <span>æœ€ä½åƒ¹æ—¥æœŸï¼š</span>
                <span id="lowestDate"></span>
            </div>
            <div class="summary-item">
                <span>ç¸½äº¤æ˜“é‡ï¼š</span>
                <span id="totalVolume"></span>
            </div>
            <div class="trend-info" id="trendInfo"></div>
        </div>

        <!-- æŸ¥è©¢çµæœè¡¨æ ¼å’Œåœ–è¡¨ -->
        <div id="result">
            <div class="chart-container" style="position: relative; height:400px; width:100%; margin-bottom: 20px;">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="table-container">
                <table id="dataTable" style="display: none;">
                    <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>å¸‚å ´</th>
                        <th>ç”¢å“</th>
                        <th>æœ€é«˜åƒ¹</th>
                        <th>ä¸­é–“åƒ¹</th>
                        <th>æœ€ä½åƒ¹</th>
                        <th>å¹³å‡åƒ¹</th>
                        <th>äº¤æ˜“é‡</th>
                    </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <!-- åˆ†é  -->
            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // å…¨å±€è®Šé‡
        let allData = [];
        const PAGE_SIZE = 10; // æ¯é é¡¯ç¤ºçš„è¨˜éŒ„æ•¸
        let currentPage = 1;
        let availableMarkets = [];

        // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨
        function initializeDates() {
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(today.getMonth() - 1);

            document.getElementById('startDate').valueAsDate = lastMonth;
            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('inputDate').valueAsDate = today;

            // ç²å–å¯ç”¨å¸‚å ´åˆ—è¡¨
            fetchAvailableMarkets();
        }

        // ç²å–æ‰€æœ‰å¯ç”¨å¸‚å ´
        async function fetchAvailableMarkets() {
            showLoader();
            try {
                const response = await fetch('/api/prices');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // å¾æ•¸æ“šä¸­æå–å”¯ä¸€çš„å¸‚å ´åç¨±
                const markets = [...new Set(data.map(item => item.market))];
                availableMarkets = markets;

                // æ›´æ–°å¸‚å ´é¸æ“‡å™¨
                const marketFilter = document.getElementById('marketFilter');
                markets.forEach(market => {
                    const option = document.createElement('option');
                    option.value = market;
                    option.textContent = market;
                    marketFilter.appendChild(option);
                });
            } catch (error) {
                console.error('ç²å–å¸‚å ´åˆ—è¡¨éŒ¯èª¤:', error);
            } finally {
                hideLoader();
            }
        }

        // æ ¼å¼åŒ–æ•¸å­—é¡¯ç¤º
        function formatNumber(num) {
            return num ? num.toLocaleString() : '-';
        }

        // é¡¯ç¤ºåŠ è¼‰å‹•ç•«
        function showLoader() {
            document.getElementById('loaderContainer').style.display = 'flex';
        }

        // éš±è—åŠ è¼‰å‹•ç•«
        function hideLoader() {
            document.getElementById('loaderContainer').style.display = 'none';
        }

        // é¡¯ç¤ºéŒ¯èª¤æç¤º
        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            field.classList.add('error');
            errorElement.textContent = message;
        }

        // æ¸…é™¤éŒ¯èª¤æç¤º
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            const inputFields = document.querySelectorAll('.form-group input');
            errorElements.forEach(el => el.textContent = '');
            inputFields.forEach(field => field.classList.remove('error'));
        }

        // è¨ˆç®—åƒ¹æ ¼è¶¨å‹¢
        // åˆ¤æ–·æ•´æ®µæœŸé–“åƒ¹æ ¼è¶¨å‹¢ï¼ˆåªé¡¯ç¤ºä¸Šå‡æˆ–ä¸‹é™ï¼‰
        function calculateTrend(data) {
            if (data.length < 2) return '';

            let n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += data[i].average_price;
                sumXY += i * data[i].average_price;
                sumXX += i * i;
            }
            let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);

            if (slope > 0) {
                return '<span class="trend-up">æ•´é«”åƒ¹æ ¼ä¸Šå‡è¶¨å‹¢ ğŸ“ˆ</span>';
            } else if (slope < 0) {
                return '<span class="trend-down">æ•´é«”åƒ¹æ ¼ä¸‹é™è¶¨å‹¢ ğŸ“‰</span>';
            } else {
                return '';
            }
        }

        // é¡¯ç¤ºåƒ¹æ ¼çµ±è¨ˆæ‘˜è¦
        function showPriceSummary(data) {
            if (!data || data.length === 0) {
                document.getElementById('summaryContainer').style.display = 'none';
                return;
            }

            // æ’åºæ•¸æ“šæŒ‰æ—¥æœŸ
            data.sort((a, b) => new Date(a.date) - new Date(b.date));

            // è¨ˆç®—å¹³å‡åƒ¹æ ¼
            const totalPrice = data.reduce((sum, item) => sum + item.average_price, 0);
            const avgPrice = totalPrice / data.length;

            // æ‰¾å‡ºæœ€é«˜åƒ¹å’Œæœ€ä½åƒ¹çš„æ—¥æœŸ
            const highestPriceItem = [...data].sort((a, b) => b.average_price - a.average_price)[0];
            const lowestPriceItem = [...data].sort((a, b) => a.average_price - b.average_price)[0];

            // è¨ˆç®—ç¸½äº¤æ˜“é‡
            const totalVolume = data.reduce((sum, item) => sum + item.trading_volume, 0);

            // æ›´æ–°DOM
            document.getElementById('avgPrice').textContent = formatNumber(avgPrice.toFixed(2));
            document.getElementById('highestDate').textContent = `${highestPriceItem.date} (${formatNumber(highestPriceItem.average_price)})`;
            document.getElementById('lowestDate').textContent = `${lowestPriceItem.date} (${formatNumber(lowestPriceItem.average_price)})`;
            document.getElementById('totalVolume').textContent = formatNumber(totalVolume);
            document.getElementById('trendInfo').innerHTML = calculateTrend(data);

            document.getElementById('summaryContainer').style.display = 'block';
        }

        // å‰µå»ºåˆ†é 
        function createPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // ä¸Šä¸€é æŒ‰éˆ•
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ä¸Šä¸€é ';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTablePage();
                }
            });
            paginationElement.appendChild(prevButton);

            // é ç¢¼æŒ‰éˆ•
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderTablePage();
                });
                paginationElement.appendChild(pageButton);
            }

            // ä¸‹ä¸€é æŒ‰éˆ•
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ä¸‹ä¸€é ';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTablePage();
                }
            });
            paginationElement.appendChild(nextButton);
        }

        // æ¸²æŸ“ç•¶å‰é è¡¨æ ¼æ•¸æ“š
        function renderTablePage() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            // è¨ˆç®—ç•¶å‰é çš„æ•¸æ“šç¯„åœ
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = Math.min(start + PAGE_SIZE, allData.length);
            const currentPageData = allData.slice(start, end);

            // å¡«å……è¡¨æ ¼
            currentPageData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.market || '-'}</td>
                    <td>${item.product || '-'}</td>
                    <td>${formatNumber(item.high_price)}</td>
                    <td>${formatNumber(item.medium_price)}</td>
                    <td>${formatNumber(item.low_price)}</td>
                    <td>${formatNumber(item.average_price)}</td>
                    <td>${formatNumber(item.trading_volume)}</td>
                `;
                tableBody.appendChild(row);
            });

            // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
            const buttons = document.querySelectorAll('.pagination button');
            if (buttons.length > 0) {
                buttons[0].disabled = currentPage === 1; // ä¸Šä¸€é æŒ‰éˆ•
                buttons[buttons.length - 1].disabled = currentPage === Math.ceil(allData.length / PAGE_SIZE); // ä¸‹ä¸€é æŒ‰éˆ•

                // æ›´æ–°æ´»å‹•é æŒ‰éˆ•æ¨£å¼
                document.querySelectorAll('.pagination button:not(:first-child):not(:last-child)').forEach((button, index) => {
                    button.className = index + 1 === currentPage ? 'active' : '';
                });
            }
        }

        // æŸ¥è©¢åƒ¹æ ¼æ•¸æ“š
        async function queryPrices() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const marketFilter = document.getElementById('marketFilter').value;
            const tableBody = document.getElementById('tableBody');
            const dataTable = document.getElementById('dataTable');
            const resultContainer = document.querySelector('.result-container');

            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡èµ·å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('èµ·å§‹æ—¥æœŸä¸èƒ½å¤§æ–¼çµæŸæ—¥æœŸ');
                return;
            }

            showLoader();
            try {
                const response = await fetch(`/api/prices/range?start=${startDate}&end=${endDate}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // æ¸…ç©ºè¡¨æ ¼å…§å®¹
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    alert('æŸ¥è©¢æ™‚é–“ç¯„åœå…§æ²’æœ‰è³‡æ–™');
                    dataTable.style.display = 'none';
                    resultContainer.style.display = 'none';
                    return;
                }

                // æ‡‰ç”¨å¸‚å ´éæ¿¾
                let filteredData = data;
                if (marketFilter) {
                    // æ”¹ç‚ºæ¨¡ç³Šæœå°‹ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                    const keyword = marketFilter.trim().toLowerCase();
                    filteredData = data.filter(item => item.market && item.market.toLowerCase().includes(keyword));
                }

                if (filteredData.length === 0) {
                    alert('æ‰€é¸å¸‚å ´åœ¨æŸ¥è©¢æ™‚é–“ç¯„åœå…§æ²’æœ‰è³‡æ–™');
                    dataTable.style.display = 'none';
                    resultContainer.style.display = 'none';
                    return;
                }

                // å„²å­˜æ‰€æœ‰æ•¸æ“šç”¨æ–¼åˆ†é 
                allData = filteredData;
                currentPage = 1;

                // é¡¯ç¤ºçµæœå®¹å™¨å’Œè¡¨æ ¼
                resultContainer.style.display = 'block';
                dataTable.style.display = 'table';

                // å‰µå»ºåˆ†é ä¸¦æ¸²æŸ“ç¬¬ä¸€é 
                createPagination(filteredData.length);
                renderTablePage();

                // é¡¯ç¤ºåƒ¹æ ¼çµ±è¨ˆæ‘˜è¦
                showPriceSummary(filteredData);

                // ç»˜åˆ¶å›¾è¡¨
                const chartData = {
                    labels: filteredData.map(item => item.date),
                    datasets: [{
                        label: 'å¹³å‡åƒ¹æ ¼è¶¨å‹¢',
                        data: filteredData.map(item => item.average_price),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'äº¤æ˜“é‡',
                        data: filteredData.map(item => item.trading_volume / 20), // ç¸®æ”¾ä»¥ä¾¿åŒåœ–é¡¯ç¤º
                        borderColor: 'rgb(153, 102, 255)',
                        borderDash: [5, 5],
                        tension: 0.1
                    }]
                };

                const ctx = document.getElementById('priceChart');
                if (window.priceLineChart) {
                    window.priceLineChart.destroy();
                }
                window.priceLineChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'è‰è“å¸‚å ´åƒ¹æ ¼è¶¨å‹¢åœ–',
                                color: '#c0392b',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'å¹³å‡åƒ¹æ ¼'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('æŸ¥è©¢éŒ¯èª¤:', error);
                alert(`æŸ¥è©¢å‡ºéŒ¯ï¼š${error.message}`);
                dataTable.style.display = 'none';
            } finally {
                hideLoader();
            }
        }

        // é©—è­‰åƒ¹æ ¼çš„åˆç†æ€§
        function validatePrices() {
            const highPrice = parseFloat(document.getElementById('inputHighPrice').value);
            const mediumPrice = parseFloat(document.getElementById('inputMediumPrice').value);
            const lowPrice = parseFloat(document.getElementById('inputLowPrice').value);
            let isValid = true;

            // æ¸…é™¤å…ˆå‰çš„éŒ¯èª¤æç¤º
            clearErrors();

            // é©—è­‰é«˜åƒ¹ >= ä¸­åƒ¹ >= ä½åƒ¹
            if (highPrice < mediumPrice) {
                showError('inputHighPrice', 'æœ€é«˜åƒ¹ä¸èƒ½å°æ–¼ä¸­é–“åƒ¹');
                isValid = false;
            }

            if (mediumPrice < lowPrice) {
                showError('inputMediumPrice', 'ä¸­é–“åƒ¹ä¸èƒ½å°æ–¼æœ€ä½åƒ¹');
                isValid = false;
            }

            return isValid;
        }

        // æäº¤è¡¨å–®æ•¸æ“š
        async function submitData() {
            // æ¸…é™¤å…ˆå‰çš„éŒ¯èª¤æç¤º
            clearErrors();

            // é©—è­‰æ‰€æœ‰å¿…å¡«æ¬„ä½
            const inputs = document.querySelectorAll('.form-group input');
            let isValid = true;

            for (let input of inputs) {
                if (!input.value) {
                    showError(input.id, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');
                    isValid = false;
                }
            }

            // é©—è­‰åƒ¹æ ¼åˆç†æ€§
            if (isValid && !validatePrices()) {
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            const formData = {
                date: document.getElementById('inputDate').value,
                market: document.getElementById('inputMarket').value,
                product: document.getElementById('inputProduct').value,
                high_price: parseFloat(document.getElementById('inputHighPrice').value),
                medium_price: parseFloat(document.getElementById('inputMediumPrice').value),
                low_price: parseFloat(document.getElementById('inputLowPrice').value),
                average_price: parseFloat(document.getElementById('inputAveragePrice').value),
                trading_volume: parseInt(document.getElementById('inputTradingVolume').value)
            };

            showLoader();
            try {
                const response = await fetch('/api/insert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('è³‡æ–™æ–°å¢æˆåŠŸï¼');
                    // æ¸…ç©ºè¡¨å–®
                    document.querySelectorAll('.form-group input').forEach(input => {
                        if (input.type !== 'date') {
                            input.value = '';
                        }
                    });

                    // èšç„¦ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
                    document.getElementById('inputMarket').focus();

                    // é‡æ–°æŸ¥è©¢ä¸¦æ›´æ–°æ•¸æ“š
                    await queryPrices();
                } else {
                    throw new Error(result.error || 'è³‡æ–™æ–°å¢å¤±æ•—');
                }
            } catch (error) {
                console.error('æäº¤éŒ¯èª¤:', error);
                alert(`æäº¤å¤±æ•—ï¼š${error.message}`);
            } finally {
                hideLoader();
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ—¥æœŸ
        window.onload = initializeDates;
    </script>
</body>
</html>
